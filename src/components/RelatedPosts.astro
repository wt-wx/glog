---
import { getRelatedPosts } from '../lib/content';
import type { CollectionEntry } from 'astro:content';
import FormattedDate from './FormattedDate.astro';
import { Image } from 'astro:assets';

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const relatedRaw = await getRelatedPosts(post);

// 1. Merge Series and Related into a single prioritized list
// Priority: Next in Series > Prev in Series > Related by Tags
const combinedPosts = [
  relatedRaw.nextInSeries ? { ...relatedRaw.nextInSeries, relType: 'Next' } : null,
  relatedRaw.prevInSeries ? { ...relatedRaw.prevInSeries, relType: 'Prev' } : null,
  ...relatedRaw.byTags.map(p => ({ ...p, relType: 'Related' }))
]
.filter((p): p is any => p !== null)
// Remove duplicates (e.g. if a tag-related post is also a series post)
.filter((p, index, self) => self.findIndex(t => t.id === p.id) === index)
.slice(0, 3);

const hasPosts = combinedPosts.length > 0;
---

{hasPosts && (
  <section class="mt-24 space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-1000">
    <div class="pt-12 border-t border-muted/30">
      <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-muted-foreground/30 italic mb-8 flex items-center gap-4">
        <span>Continue Exploring</span>
        <div class="h-px flex-1 bg-muted/20"></div>
      </h3>
      
      <div class="flex flex-col gap-1">
        {combinedPosts.map((p) => (
          <a 
            href={`/archives/${p.id}/`} 
            class="group flex flex-col md:flex-row md:items-center justify-between gap-4 md:gap-8 py-6 px-4 -mx-4 rounded-2xl hover:bg-muted/20 transition-all border-b border-muted/10 last:border-0"
          >
            <div class="flex items-start md:items-center gap-6 flex-1 min-w-0">
              {p.data.heroImage && (
                <div class="hidden sm:block shrink-0 w-32 aspect-video rounded-xl overflow-hidden bg-muted border border-muted/50 shadow-sm group-hover:border-brand/30 transition-all">
                  <Image 
                    width={240} 
                    height={135} 
                    src={p.data.heroImage} 
                    alt="" 
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" 
                  />
                </div>
              )}
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1.5 min-w-0">
                  {p.relType === 'Next' && (
                    <span class="shrink-0 text-[9px] font-black uppercase tracking-widest px-1.5 py-0.5 bg-brand/10 text-brand rounded">Next</span>
                  )}
                  {p.relType === 'Prev' && (
                    <span class="shrink-0 text-[9px] font-black uppercase tracking-widest px-1.5 py-0.5 bg-muted/50 text-muted-foreground rounded">Prev</span>
                  )}
                  <h4 class="text-lg font-bold text-foreground/90 group-hover:text-brand transition-colors line-clamp-1">
                    {p.data.title}
                  </h4>
                </div>
                <p class="text-sm text-muted-foreground/60 line-clamp-1 italic font-medium">
                  {p.data.description}
                </p>
              </div>
            </div>
            
            <div class="flex items-center gap-4 shrink-0 self-end md:self-center">
              {p.data.tags && (
                <div class="hidden lg:flex items-center gap-2">
                  {p.data.tags.slice(0, 2).map((tag: string) => (
                    <span class="text-[9px] font-bold uppercase tracking-widest px-2 py-0.5 bg-muted/10 rounded text-muted-foreground/40">
                      #{tag}
                    </span>
                  ))}
                </div>
              )}
              <div class="text-[10px] font-mono text-muted-foreground/20 tabular-nums uppercase">
                <FormattedDate date={p.data.pubDate} />
              </div>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>
)}
