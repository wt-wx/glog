---
import fs from 'fs';
import path from 'path';

interface Props {
    slug: string;
}

const { slug } = Astro.props;
let replies = [];

const commentPath = path.join(process.cwd(), 'src/data/comments', `${slug}.json`);
if (fs.existsSync(commentPath)) {
    replies = JSON.parse(fs.readFileSync(commentPath, 'utf-8'));
}
---

{replies.length > 0 && (
    <div class="mt-24 pt-12 border-t border-muted">
        <h3 class="text-2xl font-bold mb-8 flex items-center gap-3">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            Discussion from X
        </h3>
        <div class="space-y-6">
            {replies.map((reply) => (
                <div class="p-6 rounded-3xl bg-muted/20 border border-muted hover:border-brand/30 transition-all group">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-full bg-brand/10 overflow-hidden border border-muted">
                            {reply.author.profile_image_url ? (
                                <img src={reply.author.profile_image_url} alt={reply.author.name} class="w-full h-full object-cover" />
                            ) : (
                                <div class="w-full h-full flex items-center justify-center text-brand font-bold text-xs uppercase">
                                    {reply.author.name.charAt(0)}
                                </div>
                            )}
                        </div>
                        <div>
                            <p class="font-bold text-sm leading-none mb-1">{reply.author.name}</p>
                            <p class="text-xs text-muted-foreground font-mono">@{reply.author.username}</p>
                        </div>
                        <span class="ml-auto text-[10px] text-muted-foreground font-mono">
                            {new Date(reply.created_at).toLocaleDateString()}
                        </span>
                    </div>
                    <p class="text-foreground/90 leading-relaxed whitespace-pre-wrap">{reply.text}</p>
                    <div class="mt-4 flex justify-end">
                        <a 
                            href={`https://x.com/${reply.author.username}/status/${reply.id}`} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            class="text-[10px] font-bold uppercase tracking-widest text-muted-foreground hover:text-brand transition-colors flex items-center gap-1"
                        >
                            View on X
                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>
                        </a>
                    </div>
                </div>
            ))}
        </div>
        <div class="mt-12 p-8 rounded-[2rem] bg-brand text-white text-center shadow-xl shadow-brand/20">
            <p class="text-lg font-bold mb-4">Joined the conversation?</p>
            <p class="text-white/80 text-sm mb-6">Reply to the post on X to see your comments here after the next sync.</p>
            <a 
                href={`https://x.com/intent/tweet?in_reply_to=${replies[0]?.id || ''}`} 
                target="_blank" 
                class="inline-block px-8 py-3 bg-white text-brand font-bold rounded-full hover:scale-105 transition-all active:scale-95 shadow-lg"
            >
                Post a Reply
            </a>
        </div>
    </div>
)}
