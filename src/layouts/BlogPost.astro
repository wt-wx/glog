---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import PodcastStatus from '../components/PodcastStatus.astro';

import Giscus from '../components/Giscus.astro';
import XReplies from '../components/XReplies.astro';

import RelatedPosts from '../components/RelatedPosts.astro';
import TableOfContents from '../components/TableOfContents.astro';

type Props = { 
	post: CollectionEntry<'blog'>;
	headings?: { depth: number; slug: string; text: string }[];
	seriesPosts?: CollectionEntry<'blog'>[]; // Keep for legacy if needed, but we'll use RelatedPosts
};

const { post, headings, ...rest } = Astro.props;
const data = post ? post.data : rest;
const { title, description, pubDate, updatedDate, heroImage, tags, author } = data;
const id = post ? post.id : 'page';
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
	</head>

	<body class="bg-background text-foreground antialiased transition-colors duration-300">
		<div id="progress-bar" class="fixed top-0 left-0 h-1 bg-brand z-[60] transition-all duration-150 w-0 shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
		<Header />
		
		<main class="max-w-7xl mx-auto px-6 py-12 md:py-24 animate-in fade-in duration-700 relative">
			<div class="flex flex-col items-center">
				<article class="w-full max-w-3xl">
					<nav class="mb-8">
						<a href="/blog" class="group inline-flex items-center gap-2 text-muted-foreground hover:text-brand transition-all font-semibold">
							<span class="transition-transform group-hover:-translate-x-1">‚Üê</span>
							<span>Back</span>
						</a>
					</nav>
					<header class="mb-12 text-center md:text-left relative">
						<div class="flex items-center gap-2 text-muted-foreground font-mono text-sm mb-4 justify-center md:justify-start">
							<FormattedDate date={pubDate} />
							{
								updatedDate && (
									<span class="italic text-brand/60">
										(Updated on <FormattedDate date={updatedDate} />)
									</span>
								)
							}
						</div>
						<h1 class="text-4xl md:text-6xl font-black tracking-tight mb-6 leading-tight">
							{title}
						</h1>
						<p class="text-xl text-muted-foreground leading-relaxed">
							{description}
						</p>
					</header>

					{heroImage && (
						<div class="rounded-3xl overflow-hidden shadow-2xl mb-16 aspect-video shrink-0 bg-muted">
							<Image width={1020} height={510} src={heroImage} alt="" class="w-full h-full object-cover" />
						</div>
					)}

					<TableOfContents headings={headings} />
					
					<div class="prose prose-lg dark:prose-invert prose-indigo max-w-none">
						<slot />
					</div>

					<div class="mt-16 flex flex-col gap-10 pt-10 border-t border-muted/30">
						{author && (
							<div class="flex flex-col items-end self-end gap-1.5">
								<span class="text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground/40 italic">Written By</span>
								<div class="flex items-center gap-3">
									<div class="w-12 h-[2px] bg-brand/40"></div>
									<span class="text-xl font-black tracking-tight text-foreground/90">{author}</span>
								</div>
							</div>
						)}
						{tags && tags.length > 0 && (
							<div class="flex flex-wrap gap-2.5">
								{tags.map((tag) => (
									<a 
									  href={`/tags/${tag}`} 
									  class="text-xs font-bold px-3.5 py-2 bg-muted/30 hover:bg-brand/10 hover:text-brand rounded-xl text-muted-foreground/80 transition-all border border-transparent hover:border-brand/20 tracking-wide uppercase"
									>
									  #{tag}
									</a>
								))}
							</div>
						)}
					</div>

					<PodcastStatus blogPostId={id} showDetails={false} />

					{/* 1.9 Related Content & Series Navigation */}
					{post && <RelatedPosts post={post} />}

					<XReplies slug={id} />
					<Giscus />
				</article>

			</div>
		</main>
		<Footer />

		<script>
			// Reading Progress Bar
			const updateProgressBar = () => {
				const progressBar = document.getElementById('progress-bar');
				if (progressBar) {
					const totalHeight = document.documentElement.scrollHeight - window.innerHeight;
					const progress = totalHeight > 0 ? (window.scrollY / totalHeight) * 100 : 0;
					progressBar.style.width = `${progress}%`;
				}
			};

			document.addEventListener('astro:page-load', () => {
				window.addEventListener('scroll', updateProgressBar);
				updateProgressBar();
			});
		</script>
	</body>
</html>
