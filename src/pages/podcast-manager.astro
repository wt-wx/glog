---
const { getConversionProgress } = await import('../lib/podcast/index.mjs');

interface PodcastEpisode {
  id: string;
  title: string;
  description: string;
  audioUrl: string;
  shareUrl: string;
  publishedAt: string;
  duration: number;
  status: 'draft' | 'scheduled' | 'published';
  createdAt: string;
}

interface HostingStats {
  totalEpisodes: number;
  publishedEpisodes: number;
  draftEpisodes: number;
  scheduledEpisodes: number;
  totalDownloads: number;
  averageDownloads: number;
}

interface Props {
  postId: string;
  showManagement?: boolean;
}

const { postId, showManagement = false } = Astro.props;

let conversionProgress = null;

if (postId) {
  try {
    conversionProgress = await getConversionProgress(postId);
  } catch (error) {
    console.error('[Podcast Manager] è·å–è½¬æ¢çŠ¶æ€å¤±è´¥:', error);
  }
}

const getStatusColor = (status: string) => {
  switch (status) {
    case 'published':
      return 'bg-green-100 text-green-700';
    case 'scheduled':
      return 'bg-yellow-100 text-yellow-700';
    case 'draft':
      return 'bg-gray-100 text-gray-700';
    default:
      return 'bg-blue-100 text-blue-700';
  }
};

const getStatusIcon = (status: string) => {
  switch (status) {
    case 'published':
      return 'âœ…';
    case 'scheduled':
      return 'â°';
    case 'draft':
      return 'ğŸ“';
    default:
      return 'ğŸ”„';
  }
};
---

<div class="podcast-manager">
  <h2>ğŸ™ï¸ æ’­å®¢ç®¡ç†æ§åˆ¶å°</h2>

  {showManagement && conversionProgress && conversionProgress.status === 'completed' && (
    <section class="publish-section">
      <h3>å‘å¸ƒæ’­å®¢åˆ° Transistor.fm</h3>
      <p class="description">å°†å·²ç”Ÿæˆçš„æ’­å®¢ episode è‡ªåŠ¨å‘å¸ƒåˆ°æ’­å®¢æ‰˜ç®¡å¹³å°</p>
      
      <div class="actions">
        <button id="publish-btn" class="btn btn-primary" onclick="publishToTransistor()">
          ğŸ“¡ å‘å¸ƒåˆ° Transistor.fm
        </button>
        
        <button id="publish-then-tweet-btn" class="btn btn-twitter" onclick="publishAndTweet()">
          ğŸ¦ å‘å¸ƒåˆ° Twitter
        </button>
      </div>
      
      <div id="publish-status" class="status-message"></div>
    </section>
  )}
  
  {showManagement && (
    <section class="show-info-section">
      <h3>æ’­å®¢èŠ‚ç›®ä¿¡æ¯</h3>
      <p>è¯·å…ˆé…ç½® Transistor.fm API å¯†é’¥å’ŒèŠ‚ç›® ID</p>
      
      <div class="form-group">
        <label>
          Transistor.fm API å¯†é’¥
        </label>
        <input 
          type="password" 
          id="transistor-api-key" 
          placeholder="your_api_key_here" 
          value=""
        />
        
        <label>
          æ’­å®¢èŠ‚ç›® IDï¼ˆå¯é€‰ï¼‰
        </label>
        <input 
          type="text" 
          id="podcast-show-id" 
          placeholder="ç•™ç©ºä½¿ç”¨è‡ªåŠ¨è·å–"
          value=""
        />
        
        <button class="btn btn-secondary" onclick="loadShowInfo()">
          ğŸ” åŠ è½½èŠ‚ç›®ä¿¡æ¯
        </button>
      </div>
      
      <div id="show-info-result" class="show-info-result hidden"></div>
    </section>
  )}
  
  {showManagement && conversionProgress && conversionProgress.status !== 'completed' && (
    <section class="episodes-section">
      <h3>æ’­å®¢ Episodes ç®¡ç†</h3>
      
      <div class="actions-toolbar">
        <button class="btn btn-secondary" onclick="loadEpisodes()">
          ğŸ“‹ åŠ è½½æ‰€æœ‰ Episodes
        </button>
        
        <button class="btn btn-secondary" onclick="refreshEpisodes()">
          ğŸ”„ åˆ·æ–°åˆ—è¡¨
        </button>
        
        <button class="btn btn-danger" onclick="clearDrafts()">
          ğŸ—‘ï¸ æ¸…ç†è‰ç¨¿
        </button>
      </div>
      
      <div id="episodes-table-container">
        <table class="episodes-table">
          <thead>
            <tr>
              <th>çŠ¶æ€</th>
              <th>æ ‡é¢˜</th>
              <th>æ—¶é•¿</th>
              <th>å‘å¸ƒæ—¶é—´</th>
              <th>ä¸‹è½½</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="episodes-tbody">
            <tr>
              <td colspan="7" class="loading-row">
                <span class="spinner"></span>
                åŠ è½½ä¸­...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div id="episodes-stats" class="episodes-stats hidden">
        <p>æ€»è®¡: <span id="stats-total">0</span> | å·²å‘å¸ƒ: <span id="stats-published">0</span> | è‰ç¨¿: <span id="stats-draft">0</span> | å·²è°ƒåº¦: <span id="stats-scheduled">0</span></p>
      </div>
    </section>
  )}
  
  {conversionProgress && conversionProgress.status !== 'completed' && (
    <section class="conversion-status-section">
      <h3>ğŸ™ï¸ è½¬æ¢çŠ¶æ€</h3>
      
      <div class="status-card">
        <div class="status-indicator">
          <span class="status-dot {getStatusColor(conversionProgress.status)}"></span>
          <span class="status-text">{getStatusIcon(conversionProgress.status)} {conversionProgress.status || 'è¿›è¡Œä¸­'}</span>
        </div>
        
        <div class="status-details">
          <p><strong>å½“å‰é˜¶æ®µ:</strong> {conversionProgress.stages ? Object.keys(conversionProgress.stages).length : 0} ä¸ª</p>
          
          {conversionProgress.stages && (
            <div class="stages-list">
              {Object.entries(conversionProgress.stages).map(([stageName, stage]: [string, any]) => (
                <div class="stage-item">
                  <span class="stage-name">{stageName}</span>
                  <span class="stage-status {getStatusColor(stage.status)}">{getStatusIcon(stage.status)}</span>
                  {stage.endTime && (
                    <span class="stage-time">
                      {new Date(stage.endTime).toLocaleTimeString()}
                    </span>
                  )}
                </div>
              ))}
            </div>
          )}
          
          {conversionProgress.error && (
            <div class="error-message">
              <p class="error-title">âŒ è½¬æ¢å¤±è´¥</p>
              <p class="error-details">{conversionProgress.error}</p>
            </div>
          )}
        </div>
      </div>
    </section>
  )}
  
  {showManagement && conversionProgress && conversionProgress.status === 'completed' && conversionProgress.result && (
    <section class="episode-details-section">
      <h3>ğŸ™ï¸ Episode ä¿¡æ¯</h3>
      
      <div class="episode-card">
        <h4>æ ‡é¢˜: {conversionProgress.result.metadata.title}</h4>
        <p class="description">{conversionProgress.result.metadata.description}</p>
        
        <div class="episode-info">
          <div class="info-item">
            <span class="info-label">æ—¶é•¿:</span>
            <span class="info-value">{conversionProgress.result.duration.minutes} åˆ†é’Ÿ {conversionProgress.result.duration.seconds} ç§’</span>
          </div>
          
          <div class="info-item">
            <span class="info-label">éŸ³é¢‘é“¾æ¥:</span>
            <a href="{conversionProgress.result.audioUrl}" target="_blank" class="audio-link">
              ğŸ§ æ”¶å¬æ’­å®¢
            </a>
          </div>
          
          <div class="info-item">
            <span class="info-label">åˆ†äº«é“¾æ¥:</span>
            <a href="{conversionProgress.result.shareUrl}" target="_blank" class="share-link">
              ğŸ”— åˆ†äº«ç»™æœ‹å‹
            </a>
          </div>
          
          {conversionProgress.result.qualityScore && (
            <div class="info-item">
              <span class="info-label">è´¨é‡è¯„åˆ†:</span>
              <span class="info-value quality-score">{conversionProgress.result.qualityScore}</span>
            </div>
          )}
        </div>
      </div>
    </section>
  )}
  
  <section class="actions-section">
    <h3>æ“ä½œ</h3>
    
    <div class="action-buttons">
      <button class="btn btn-secondary" onclick="copyAudioUrl()">
        ğŸ“‹ å¤åˆ¶éŸ³é¢‘é“¾æ¥
      </button>
      
      <button class="btn btn-secondary" onclick="openInNewTab()">
        ğŸ”— åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
      </button>
      
      <button class="btn btn-secondary" onclick="showRSS()">
        ğŸ“¡ æŸ¥çœ‹ RSS Feed
      </button>
    </div>
  </section>

  <style>
    .podcast-manager {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #e5e7eb;
    }
    
    h3 {
      font-size: 1.25rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 1rem;
    }
    
    section {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .description {
      color: #6b7280;
      margin-bottom: 0.5rem;
      line-height: 1.6;
    }
    
    .actions {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .actions-toolbar {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #374151;
    }
    
    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.375rem;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn:active {
      transform: translateY(-1px);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #5b5bd9 0%, #6b4e9e 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }
    
    .btn-secondary {
      background: #f3f4f6;
      color: #1f2937;
      border: 1px solid #e5e7eb;
    }
    
    .btn-secondary:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
      border: 1px solid #dc2626;
    }
    
    .btn-danger:hover {
      background: #dc2626;
      border-color: #b91c1c;
    }
    
    .status-message {
      padding: 1rem;
      background: #dbeafe;
      border: 1px solid #b8e4b9;
      border-radius: 0.375rem;
      margin-top: 1rem;
      font-weight: 500;
    }
    
    .status-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1.5rem;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      
      50% {
        opacity: 0.5;
      }
    }
    
    .status-details {
      margin-top: 0.5rem;
    }
    
    .stages-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
    }
    
    .stage-item {
      padding: 0.75rem;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
    }
    
    .stage-name {
      font-weight: 600;
      color: #374151;
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }
    
    .stage-status {
      font-size: 1.125rem;
    }
    
    .stage-time {
      font-size: 0.75rem;
      color: #6b7280;
      font-family: monospace;
    }
    
    .loading-row {
      text-align: center;
      padding: 2rem;
    }
    
    .spinner {
      border: 3px solid #3b82f6;
      border-top-color: #3b82f6;
      border-right-color: transparent;
      border-bottom-color: #3b82f6;
      border-left-color: transparent;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      
      100% {
        transform: rotate(360deg);
      }
    }
    
    .episodes-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 0.5rem;
      overflow: hidden;
    }
    
    .episodes-table thead {
      background: #f9fafb;
      font-weight: 600;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .episodes-table th {
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      color: #374151;
      white-space: nowrap;
    }
    
    .episodes-table tbody {
      font-size: 0.875rem;
    }
    
    .episodes-table tbody tr {
      border-bottom: 1px solid #e5e7eb;
      transition: background  0.2s ease;
    }
    
    .episodes-table tbody tr:hover {
      background: #f9fafb;
    }
    
    .episodes-table tbody tr:last-child {
      border-bottom: none;
    }
    
    .episodes-table td {
      padding: 0.75rem;
      text-align: left;
    vertical-align: middle;
    }
    
    .episodes-stats {
      display: flex;
      gap: 1.5rem;
      padding: 1rem;
      background: #dbeafe;
      border: 1px solid #b8e4b9;
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }
    
    .episodes-stats p {
      margin: 0;
    color: #6b7280;
    }
    
    .episode-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1.5rem;
    }
    
    .episode-card h4 {
      font-size: 1.125rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.75rem;
    }
    
    .info-item {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .info-label {
      font-weight: 500;
      color: #6b7280;
      min-width: 120px;
    }
    
    .info-value {
      color: #1f2937;
      font-weight: 600;
    }
    
    .quality-score {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: #e5e7eb;
      border-radius: 0.375rem;
      font-weight: 700;
    }
    
    .quality-score.high {
      background: #10b981;
      color: white;
    }
    
    .quality-score.medium {
      background: #f59e0b;
      color: white;
    }
    
    .quality-score.low {
      background: #ef4444;
      color: white;
    }
    
    .audio-link {
      color: #10b981;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }
    
    .audio-link:hover {
      color: #059669;
    }
    
    .share-link {
      color: #3b82f6;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }
    
    .share-link:hover {
      color: #2563eb;
    }
    
    .error-message {
      background: #fee2e2;
      border: 1px solid #fecaca;
      border-radius: 0.375rem;
      padding: 1rem;
    }
    
    .error-title {
      color: #991b1b;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .error-details {
      color: #b91c1c;
      font-size: 0.875rem;
    }
    
    .actions-section {
      padding: 1.5rem;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.5rem;
    }

    .hidden {
      display: none;
    }
    
    @media (prefers-color-scheme: dark) {
      section {
        background: #1f2937;
        border-color: #374151;
      }
      
      .episodes-table thead {
        background: #1f2937;
        border-bottom-color: #374151;
      }
      
      .episodes-table tbody tr:hover {
        background: #2d3748;
      }
      
      .episode-card {
        background: #1f2937;
        border-color: #374151;
      }
      
      .info-label {
        color: #d1d5db;
      }
      
      .episodes-stats {
        background: #1f2937;
        border-color: #374151;
      }
    }
  </style>
  
  <script>
    async function publishToTransistor() {
      const publishBtn = document.getElementById('publish-btn');
      const statusDiv = document.getElementById('publish-status');
      
      try {
        publishBtn.disabled = true;
        publishBtn.textContent = 'å‘å¸ƒä¸­...';
        statusDiv.className = 'status-message';
        statusDiv.innerHTML = '<span class="spinner"></span> æ­£åœ¨å‘å¸ƒåˆ° Transistor.fm...';
        
        const response = await fetch('/api/podcast/publish', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            postId: `${postId}`
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          
          statusDiv.className = 'status-message';
          statusDiv.innerHTML = 'âœ… å‘å¸ƒæˆåŠŸï¼Episode å·²ä¸Šä¼ åˆ° Transistor.fm';
          
          setTimeout(() => {
            statusDiv.className = 'status-message hidden';
          }, 5000);
        } else {
          throw new Error('å‘å¸ƒå¤±è´¥');
        }
      } catch (error) {
        statusDiv.className = 'status-message';
        statusDiv.innerHTML = 'âŒ å‘å¸ƒå¤±è´¥: ' + error.message;
        statusDiv.style.background = '#fee2e2';
        statusDiv.style.borderColor = '#fecaca';
      } finally {
        publishBtn.disabled = false;
        publishBtn.textContent = 'ğŸ“¡ å‘å¸ƒåˆ° Transistor.fm';
      }
    }
    
    async function publishAndTweet() {
      const publishBtn = document.getElementById('publish-then-tweet-btn');
      const statusDiv = document.getElementById('publish-status');
      
      try {
        publishBtn.disabled = true;
        publishBtn.textContent = 'å‘å¸ƒå¹¶æ¨æ–‡ä¸­...';
        statusDiv.className = 'status-message';
        statusDiv.innerHTML = '<span class="spinner"></span> æ­£åœ¨å‘å¸ƒåˆ° Transistor.fm å¹¶æ¨æ–‡...';
        
        const response = await fetch('/api/podcast/publish', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            postId: `${postId}`,
            tweet: true
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          
          statusDiv.className = 'status-message';
          statusDiv.innerHTML = 'âœ… å‘å¸ƒæˆåŠŸå¹¶æ¨æ–‡ï¼Episode å·²å‘å¸ƒåˆ° Transistor.fmï¼Œæ¨æ–‡å·²å‘é€';
          
          setTimeout(() => {
            statusDiv.className = 'status-message hidden';
          }, 5000);
        } else {
          throw new Error('å‘å¸ƒå¤±è´¥');
        }
      } catch (error) {
        statusDiv.className = 'status-message';
        statusDiv.innerHTML = 'âŒ å‘å¸ƒå¤±è´¥: ' + error.message;
        statusDiv.style.background = '#fee2e2';
        statusDiv.style.borderColor = '#fecaca';
      } finally {
        publishBtn.disabled = false;
        publishBtn.textContent = 'ğŸ¦ å‘å¸ƒåˆ° Twitter';
      }
    }
    
    async function loadShowInfo() {
      const apiKey = document.getElementById('transistor-api-key').value;
      const showId = document.getElementById('podcast-show-id').value || '';
      const resultDiv = document.getElementById('show-info-result');
      
      if (!apiKey) {
        resultDiv.innerHTML = '<p class="error-message">âŒ è¯·å…ˆè¾“å…¥ Transistor.fm API å¯†é’¥</p>';
        resultDiv.style.background = '#fee2e2';
        resultDiv.style.borderColor = '#fecaca';
        resultDiv.classList.remove('hidden');
        return;
      }
      
      try {
        const response = await fetch('/api/podcast/show-info', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            apiKey,
            showId
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          resultDiv.innerHTML = `
            <h4>ğŸ“‹ æ’­å®¢èŠ‚ç›®ä¿¡æ¯</h4>
            <div class="episode-card">
              <div class="info-item">
                <span class="info-label">æ ‡é¢˜:</span>
                <span class="info-value">${result.title || 'æœªè®¾ç½®'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">RSS Feed:</span>
                <span class="info-value"><a href="${result.feedUrl}" target="_blank">${result.feedUrl || 'æœªè®¾ç½®'}</a></span>
              </div>
              <div class="info-item">
                <span class="info-label">ä½œè€…:</span>
                <span class="info-value">${result.author || 'æœªè®¾ç½®'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">åˆ†ç±»:</span>
                <span class="info-value">${result.category || 'æœªè®¾ç½®'}</span>
              </div>
            </div>
          `;
          resultDiv.classList.remove('hidden');
        } else {
          throw new Error(result.error || 'è·å–èŠ‚ç›®ä¿¡æ¯å¤±è´¥');
        }
      } catch (error) {
        resultDiv.innerHTML = '<p class="error-message">âŒ è·å–èŠ‚ç›®ä¿¡æ¯å¤±è´¥: ' + error.message;
        resultDiv.style.background = '#fee2e2';
        resultDiv.style.borderColor = '#fecaca';
        resultDiv.classList.remove('hidden');
      }
    }
    
    async function loadEpisodes() {
      const resultDiv = document.getElementById('episodes-table-container');
      const statsDiv = document.getElementById('episodes-stats');
      const tbody = document.getElementById('episodes-tbody');
      
      try {
        const response = await fetch('/api/podcast/episodes', {
          method: 'GET'
        });
        
        const result = await response.json();
        
        if (result.success && result.episodes) {
          let stats = {
            total: result.episodes.length,
            published: result.episodes.filter(e => e.status === 'published').length,
            draft: result.episodes.filter(e => e.status === 'draft').length,
            scheduled: result.episodes.filter(e => e.status === 'scheduled').length
          };
          
          tbody.innerHTML = result.episodes.map(episode => `
            <tr>
              <td>
                <span class="status-dot ${getStatusColor(episode.status)}"></span>
                <span class="status-text">${getStatusIcon(episode.status)}</span>
              </td>
              <td><a href="${episode.shareUrl}" target="_blank">${episode.title}</a></td>
              <td>${Math.floor(episode.duration / 60)}:${episode.duration % 60}</td>
              <td>${new Date(episode.publishedAt).toLocaleString()}</td>
              <td>
                <button class="btn btn-secondary" onclick="deleteEpisode('${episode.id}')">åˆ é™¤</button>
              </td>
            </tr>
          `).join('');
          
          statsDiv.innerHTML = `
            <p>æ€»è®¡: <span class="stat-value">${stats.total}</span> | å·²å‘å¸ƒ: <span class="stat-value published">${stats.published}</span> | è‰ç¨¿: <span class="stat-value draft">${stats.draft}</span> | å·²è°ƒåº¦: <span class="stat-value scheduled">${stats.scheduled}</span></p>
          `;
          
          statsDiv.classList.remove('hidden');
        } else {
          throw new Error(result.error || 'åŠ è½½ episodes å¤±è´¥');
        }
      } catch (error) {
        resultDiv.innerHTML = '<p class="error-message">âŒ åŠ è½½å¤±è´¥: ' + error.message;
      }
    }
    
    async function clearDrafts() {
      if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰è‰ç¨¿å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
      }
      
      try {
        const response = await fetch('/api/podcast/clear-drafts', {
          method: 'DELETE'
        });
        
        if (response.ok) {
          await loadEpisodes();
        } else {
          throw new Error('æ¸…ç†å¤±è´¥');
        }
      } catch (error) {
        alert('æ¸…ç†å¤±è´¥: ' + error.message);
      }
    }
    
    async function deleteEpisode(episodeId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª episode å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/podcast/episodes/${episodeId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          await loadEpisodes();
        } else {
          throw new Error('åˆ é™¤å¤±è´¥');
        }
      } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }
    
    async function copyAudioUrl() {
      const url = `${conversionProgress?.result?.audioUrl || ''}`;
      
      if (!url) {
        alert('æ²¡æœ‰å¯å¤åˆ¶çš„éŸ³é¢‘é“¾æ¥');
        return;
      }
      
      try {
        await navigator.clipboard.writeText(url);
        alert('éŸ³é¢‘é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
      } catch (error) {
        alert('å¤åˆ¶å¤±è´¥: ' + error.message);
      }
    }
    
    async function openInNewTab() {
      const url = `${conversionProgress?.result?.audioUrl || ''}`;
      
      if (!url) {
        alert('æ²¡æœ‰å¯æ‰“å¼€çš„éŸ³é¢‘é“¾æ¥');
        return;
      }
      
      window.open(url, '_blank');
    }
    
    async function showRSS() {
      const url = `${conversionProgress?.result?.shareUrl || ''}`;
      
      if (!url) {
        alert('æ²¡æœ‰å¯æ‰“å¼€çš„åˆ†äº«é“¾æ¥');
        return;
      }
      
      window.open(url, '_blank');
    }
  </script>
</div>