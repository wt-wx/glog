---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE } from '../../consts';
import { supabaseAdmin } from '../../lib/supabase';
import { getTodayCalendarEvents, getPendingTasks } from '../../lib/google';

// ä¸é¢„æ¸²æŸ“ï¼Œå› ä¸ºæ˜¯åŠ¨æ€ç®¡ç†é¢æ¿
export const prerender = false;

// è·å– Google æˆæƒçŠ¶æ€
const { data: authState } = await supabaseAdmin
  .from('assistant_state')
  .select('*')
  .eq('id', 'google_auth')
  .maybeSingle();

const isGoogleConnected = !!authState && !authState.data?.test;
const lastSync = authState?.data?.updated_at ? new Date(authState.data.updated_at).toLocaleString('zh-CN') : 'ä»æœªåŒæ­¥';

// è·å–æ—¥ç¨‹å’Œä»»åŠ¡ (ä»…åœ¨å·²è¿æ¥æ—¶)
let events = [];
let tasks = [];
let error = null;

if (isGoogleConnected) {
  try {
    [events, tasks] = await Promise.all([
      getTodayCalendarEvents(),
      getPendingTasks()
    ]);
  } catch (e) {
    console.error('Data fetch error:', e);
    error = e.message;
  }
}

// è·å–é¡¹ç›®ç»Ÿè®¡
const { count: projectCount } = await supabaseAdmin
  .from('projects_extended')
  .select('*', { count: 'exact', head: true });

// è·å–èµ„äº§ç»Ÿè®¡
const { count: assetCount } = await supabaseAdmin
  .from('it_assets')
  .select('*', { count: 'exact', head: true });
---

<html lang="zh-CN">
	<head>
		<BaseHead title={`Command Center | ${SITE_TITLE}`} description="Genius OS æ§åˆ¶ä¸­å¿ƒ" />
	</head>
	<body class="bg-background text-foreground antialiased transition-colors duration-300">
		<Header />
		<main class="max-w-7xl mx-auto px-6 py-20">
			<header class="mb-16">
				<h1 class="text-5xl font-black mb-4 tracking-tight">Genius <span class="text-brand">OS</span></h1>
				<p class="text-xl text-muted-foreground">äº‘ç«¯å¤§è„‘æ§åˆ¶ä¸­å¿ƒ</p>
			</header>

			<div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16">
				<!-- Google Integration Status -->
				<div class="p-8 rounded-3xl border border-muted bg-white/5 dark:bg-white/5 backdrop-blur-sm">
					<div class="flex items-center justify-between mb-6">
						<h3 class="text-xl font-bold">Google é›†æˆ</h3>
						<div class={`w-3 h-3 rounded-full ${isGoogleConnected ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]' : 'bg-red-500'}`}></div>
					</div>
					<div class="space-y-4">
						<div class="flex justify-between text-sm">
							<span class="text-muted-foreground">çŠ¶æ€</span>
							<span class="font-mono">{isGoogleConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}</span>
						</div>
						<div class="flex justify-between text-sm">
							<span class="text-muted-foreground">æœ€åå¿ƒè·³</span>
							<span class="font-mono">{lastSync}</span>
						</div>
						<div class="pt-4">
							<a 
								href="/api/auth/google/login" 
								class={`block text-center py-3 rounded-xl font-bold transition-all ${isGoogleConnected ? 'bg-muted text-muted-foreground hover:bg-brand hover:text-white' : 'bg-brand text-white shadow-lg shadow-brand/20 hover:scale-105'}`}
							>
								{isGoogleConnected ? 'é‡æ–°è¿æ¥ Google' : 'ç«‹å³è¿æ¥ Google'}
							</a>
						</div>
                        {error && <p class="text-[10px] text-red-500 mt-2">é”™è¯¯: {error}</p>}
					</div>
				</div>

				<!-- Project Progress -->
				<div class="p-8 rounded-3xl border border-muted bg-white/5 dark:bg-white/5 backdrop-blur-sm">
					<h3 class="text-xl font-bold mb-6">é¡¹ç›®è¿›ç¨‹</h3>
					<div class="space-y-4">
						<div class="flex justify-between text-sm">
							<span class="text-muted-foreground">æ´»è·ƒé¡¹ç›®</span>
							<span class="font-mono text-2xl font-black">{projectCount || 0}</span>
						</div>
						<div class="pt-4">
							<a href="/projects" class="text-sm font-bold text-brand hover:underline">æŸ¥çœ‹å…¨é‡è·¯çº¿å›¾ â†’</a>
						</div>
					</div>
				</div>

				<!-- IT Assets -->
				<div class="p-8 rounded-3xl border border-muted bg-white/5 dark:bg-white/5 backdrop-blur-sm">
					<h3 class="text-xl font-bold mb-6">IT èµ„äº§</h3>
					<div class="space-y-4">
						<div class="flex justify-between text-sm">
							<span class="text-muted-foreground">ç®¡æ§èµ„æº</span>
							<span class="font-mono text-2xl font-black">{assetCount || 0}</span>
						</div>
						<div class="pt-4 text-xs text-muted-foreground italic">
							æ­£åœ¨æ¥å…¥ Dokploy ç›‘æ§...
						</div>
					</div>
				</div>
			</div>

			<section class="mt-20">
				<div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-bold">ä»Šæ—¥å¤§è„‘ç®€æŠ¥</h2>
                    <button 
                        id="push-tg-btn"
                        class="px-4 py-2 rounded-full bg-brand/10 text-brand text-xs font-bold hover:bg-brand hover:text-white transition-all flex items-center gap-2"
                        disabled={!isGoogleConnected}
                    >
                        <span>âœˆï¸</span> æ¨é€åˆ° Telegram
                    </button>
                </div>
                
				<div class="grid grid-cols-1 md:grid-cols-2 gap-8">

                    <!-- Calendar Section -->
					<div class="space-y-4">
                        <div class="flex items-center gap-2 mb-4">
                            <span class="text-xl">ğŸ“…</span>
                            <h3 class="font-bold">ä»Šæ—¥æ—¥ç¨‹</h3>
                        </div>
                        <div class="space-y-3">
                            {events.length > 0 ? events.map(event => (
                                <div class="p-4 rounded-2xl bg-muted/20 border border-muted/50 flex justify-between items-center group hover:bg-muted/30 transition-all">
                                    <div class="font-medium">{event.summary}</div>
                                    <div class="text-xs text-muted-foreground font-mono">
                                        {event.start?.dateTime ? new Date(event.start.dateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'å…¨å¤©'}
                                    </div>
                                </div>
                            )) : (
                                <div class="text-muted-foreground italic text-sm p-4">ä»Šå¤©æ²¡æœ‰å®‰æ’ï¼Œäº«å—è‡ªç”±çš„ä¸€å¤©ï¼</div>
                            )}
                        </div>
                    </div>

                    <!-- Tasks Section -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-4">
                            <span class="text-xl">âœ…</span>
                            <h3 class="font-bold">å¾…åŠäº‹é¡¹</h3>
                        </div>
                        <div class="space-y-3">
                            {tasks.length > 0 ? tasks.map(task => (
                                <div class="p-4 rounded-2xl bg-muted/20 border border-muted/50 group hover:bg-brand/5 hover:border-brand/20 transition-all">
                                    <div class="font-medium mb-1">{task.title}</div>
                                    {task.notes && <div class="text-xs text-muted-foreground line-clamp-1">{task.notes}</div>}
                                </div>
                            )) : (
                                <div class="text-muted-foreground italic text-sm p-4">æ¸…å•å·²æ¸…ç©ºï¼Œæ‚¨å¤ªé«˜æ•ˆäº†ï¼</div>
                            )}
                        </div>
                    </div>
				</div>
			</section>
		</main>
            <script>
                document.getElementById('push-tg-btn')?.addEventListener('click', async (e) => {
                    const btn = e.currentTarget as HTMLButtonElement;
                    const originalText = btn.innerHTML;
                    
                    btn.disabled = true;
                    btn.innerHTML = '<span>â³</span> æ­£åœ¨æ¨é€...';
                    
                    try {
                        const res = await fetch('/api/assistant/push-briefing', { method: 'POST' });
                        const data = await res.json();
                        if (data.success) {
                            btn.innerHTML = '<span>âœ…</span> å·²å‘é€åˆ°æ‰‹æœº';
                            setTimeout(() => { 
                                btn.innerHTML = originalText; 
                                btn.disabled = false; 
                            }, 3000);
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (err: any) {
                        alert('æ¨é€å¤±è´¥: ' + err.message);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                });
            </script>
		<Footer />
	</body>
</html>
